<!DOCTYPE html>
<html>
    <head>
        <title>Daily Bible Reading</title>
    </head>
    <body>
        <h1>Welcome to the Daily Reading Plan page</h1>
        <div id="today"></div>
        <div id="reading"></div>
        <div id="biblegateway"></div>
        <fieldset>
            <h3>Options</h3>
            <div><strong>Translation:</strong> <input type="text" name="translation" id="translation" maxlength="5"></div>
            <h4>Future Options, current values</h4>
            <div><strong>Reading Plan:</strong> 15 minutes / day</div>
            <div><strong>Website:</strong> bible gateway</div>
        </fieldset>
        <div id="missed"></div>
        <script src="domready.js" type="text/javascript"></script>
        <script type="text/javascript">
            function loadPlan(which) {
                var req = new XMLHttpRequest();
                req.open("GET",which,false);
                req.send(null);
                window.plan = JSON.parse(req.responseText);
            }
            function getPlanIndex() {
                var today = new Date();

                var dayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
                var mn = today.getMonth();
                var dn = today.getDate();
                if(mn == 1 && dn == 29) { return 365; }
                var dayOfYear = dayCount[mn] + dn;
                return dayOfYear-1;
            };
            function updateURL(){
                var reading = window.plan.readings[getPlanIndex()];
                document.getElementById('today').innerHTML = 'Today is '+reading.date;
                document.getElementById('reading').innerHTML = 'Our reading for today is ' + reading.passage;
                var a = document.createElement('a');
                a.href = 'https://www.biblegateway.com/passage/?search='+encodeURIComponent(reading.passage)+'&version='+document.getElementById('translation').value;
                console.log(a.href);
                a.innerHTML = "Read it!";
                var bg = document.getElementById('biblegateway');
                bg.innerHTML = "";
                bg.appendChild(a);

                var yesterreading = window.plan.readings[getPlanIndex()-1]; //todo: fix new years
                var ay = document.createElement('a');
                ay.href = 'https://www.biblegateway.com/passage/?search='+encodeURIComponent(yesterreading.passage)+'&version='+document.getElementById('translation').value;
                ay.innerHTML = "Read it!";
                var yesterday = document.getElementById('missed');
                yesterday.innerHTML = "If you missed yesterday, ";
                yesterday.appendChild(ay);
            }
            
            DomReady.ready(function() {
                if(localStorage['plan'] == '5') {
                    loadPlan("5minute.js");
                } else {
                    loadPlan("15minute.js");
                }
                var trans = localStorage['translation'] || 'NLT';
                var translation_input = document.getElementById('translation');
                translation_input.value = trans;
                translation_input.onkeyup = function() {
                    localStorage['translation'] = translation_input.value;
                    updateURL();
                };
                updateURL();
            });
        </script>
    </body>
</html>